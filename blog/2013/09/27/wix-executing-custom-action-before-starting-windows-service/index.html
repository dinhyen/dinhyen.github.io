
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Wix: Executing custom action before starting Windows service - Yen's Blog</title>
  <meta name="author" content="Yen Tran">

  
  <meta name="description" content="I&rsquo;ve been trying to get a Wix installer to work. This particular scenario is pretty simple. I want to configure the database via a custom &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dinhyen.github.io/blog/2013/09/27/wix-executing-custom-action-before-starting-windows-service">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Yen's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/darkbox.css" rel="stylesheet" type="text/css">
<script src="/javascripts/darkbox.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24469490-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Yen's Blog</a></h1>
  
    <h2>Lens, Wheels, Skates, Keyboard</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dinhyen.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/travel">Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Wix: Executing Custom Action Before Starting Windows Service</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-27T00:00:00-04:00" pubdate data-updated="true">Sep 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;ve been trying to get a Wix installer to work. This particular scenario is pretty simple. I want to configure the database via a custom action, then start a Windows service which then queries the database before starting.  This would seem like a commonplace scenario. However, Wix documentations are sparse and I&rsquo;ve been wrangling with this for some time.  I finally found a solution.  While I loathe to reference a StackOverflow answer, as a favor to my future self I&rsquo;m going to do so anyways.</p>

<p>The following defines the component that installs and starts the service and creates a feature that references it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;ComponentGroup</span> <span class="na">Id=</span><span class="s">&#39;b_SyncSvcComps&#39;</span> <span class="na">Directory=</span><span class="s">&#39;b_SyncInstallDir&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">&#39;b_SyncSvc&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;File</span> <span class="na">Id=</span><span class="s">&#39;b_SyncExe&#39;</span> <span class="na">Name=</span><span class="s">&#39;MyService.exe&#39;</span> <span class="na">Source=</span><span class="s">&#39;$(var.syncSrcDir)\MyService.exe&#39;</span> <span class="na">DiskId=</span><span class="s">&#39;1&#39;</span> <span class="na">KeyPath=</span><span class="s">&#39;yes&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ServiceInstall</span> <span class="na">Id=</span><span class="s">&#39;b_InstallSyncSvc&#39;</span> <span class="na">Type=</span><span class="s">&#39;ownProcess&#39;</span> <span class="na">Name=</span><span class="s">&#39;MyService&#39;</span> <span class="na">DisplayName=</span><span class="s">&#39;My Service&#39;</span> <span class="na">Description=</span><span class="s">&#39;My Service&#39;</span> <span class="na">Start=</span><span class="s">&#39;auto&#39;</span> <span class="na">Account=</span><span class="s">&#39;[SERVICEACCOUNT]&#39;</span> <span class="na">Password=</span><span class="s">&#39;[SERVICEPASSWORD]&#39;</span> <span class="na">ErrorControl=</span><span class="s">&#39;normal&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ServiceControl</span> <span class="na">Id=</span><span class="s">&#39;b_StartSyncSvc&#39;</span> <span class="na">Start=</span><span class="s">&#39;install&#39;</span> <span class="na">Stop=</span><span class="s">&#39;both&#39;</span> <span class="na">Remove=</span><span class="s">&#39;uninstall&#39;</span> <span class="na">Name=</span><span class="s">&#39;MyService&#39;</span> <span class="na">Wait=</span><span class="s">&#39;yes&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/Component&gt;</span>
</span><span class='line'><span class="nt">&lt;/ComponentGroup&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">&#39;b_ConnectedModeFeature&#39;</span> <span class="na">Title=</span><span class="s">&#39;Connected Mode Features&#39;</span> <span class="na">Level=</span><span class="s">&#39;1&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;ComponentGroupRef</span> <span class="na">Id=</span><span class="s">&#39;b_SyncSvcComps&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Feature&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following snippet in Product.wxs actually installs the feature:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">&#39;b_Features&#39;</span> <span class="na">Title=</span><span class="s">&#39;[ProductName]&#39;</span> <span class="na">Level=</span><span class="s">&#39;1&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;FeatureRef</span> <span class="na">Id=</span><span class="s">&#39;b_ConnectedModeFeature&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Feature&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the initial version of the custom action that I want to run.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">&quot;DbBatchCmd&quot;</span> <span class="na">Directory=</span><span class="s">&#39;B_DBINSTALLDIR&#39;</span> <span class="na">Execute=</span><span class="s">&quot;immediate&quot;</span> <span class="na">Impersonate=</span><span class="s">&quot;yes&quot;</span> <span class="na">Return=</span><span class="s">&quot;check&quot;</span> <span class="na">ExeCommand=</span><span class="s">&quot;[SystemFolder]\cmd /c &amp;quot;&amp;quot;setup_database.cmd&amp;quot; &amp;quot;[b_WebServer]&amp;quot; &amp;quot;[b_DbServer]&amp;quot;&amp;quot;&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following snippet in Product.wxs runs the custom action.  Here it is run after InstallFinalize, the last possible step in the installation&rsquo;s sequence of events.  The condition ensures that it is only run if the product isn&rsquo;t already installed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;InstallExecuteSequence&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">&quot;DbBatchCmd&quot;</span> <span class="na">After=</span><span class="s">&quot;InstallFinalize&quot;</span><span class="nt">&gt;</span>NOT Installed<span class="nt">&lt;/Custom&gt;</span>
</span><span class='line'><span class="nt">&lt;/InstallExecuteSequence&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>According to the above, the installer tries to start the service before it runs the custom action to configure the database.  Of course, since the service requires the database to be set up, it balks.</p>

<p>Among others, I tried running the custom action earlier using the <code>Before="StartServices"</code> and <code>After="InstallFiles"</code> attributes. The latter makes sense because the installer needs to copy files to the file system before it can execute the script.  When inspected with Orca, the MSI has the correct InstallExecuteSequence:</p>

<pre>
...
InstallFiles              4000
DbBatchCmd  NOT Installed 4001
InstallServices VersionNT 5800
StartServices VersionNT   5900
...
InstallFinalize           6600
</pre>


<p>However, the installer never executes the custom action.  It always tries to start the service and almost immediately fails. In fact, the custom action only runs when it&rsquo;s set to <code>After="InstallFinalize"</code> as above.</p>

<p>One of the key things was provided by the helpful if somewhat verbose Windows installer log, which is created when you start the installer as follows:</p>

<pre>
msiexec /i myinstaller.msi /l*v myinstaller.log
</pre>


<p>Someday, Microsoft will have consistent command-line arguments.  The log has this to say about the service:</p>

<pre>
MSI (s) (3C:A8) [17:10:02:607]: Note: 1: 2262 2: Error 3: -2147287038 
Info 1721.There is a problem with this Windows Installer package. A program required for this install to complete could not be run. Contact your support personnel or package vendor. Action: DbBatchCmd, location: C:\inetpub\wwwroot\MyApp\Database\, command: C:\Windows\SysWOW64\\cmd /c ""setup_database.cmd" "my_webserver" "my_dbserver"" 
Action ended 17:10:02: ShipBatchCmd. Return value 1.
</pre>


<p>This is followed by entries for InstallServices and StartServices.  So the installer does try to run the custom action but fails.</p>

<p>The <a href="http://stackoverflow.com/questions/778210/wix-trying-to-figure-out-install-sequences">answer</a> is provided by Rob Mensching, who created Wix.  According to him, <code>After="InstallFiles"</code> is correct. However, the execution needs to be &ldquo;deferred&rdquo; until the files are actually copied to the file system.  Below is the corrected XML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">&quot;DbBatchCmd&quot;</span> <span class="na">Directory=</span><span class="s">&#39;B_DBINSTALLDIR&#39;</span> <span class="na">Execute=</span><span class="s">&quot;deferred&quot;</span> <span class="na">ExeCommand=</span><span class="s">&quot;[SystemFolder]\cmd /c &amp;quot;&amp;quot;setup_database.cmd&amp;quot; &amp;quot;[b_WebServer]&amp;quot; &amp;quot;[b_DbServer]&amp;quot;&amp;quot;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;InstallExecuteSequence&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">&quot;DbBatchCmd&quot;</span> <span class="na">After=</span><span class="s">&quot;InstallFiles&quot;</span><span class="nt">&gt;</span>NOT Installed<span class="nt">&lt;/Custom&gt;</span>
</span><span class='line'><span class="nt">&lt;/InstallExecuteSequence&gt;</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yen Tran</span></span>

      








  


<time datetime="2013-09-27T00:00:00-04:00" pubdate data-updated="true">Sep 27<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://dinhyen.github.io/blog/2013/09/27/wix-executing-custom-action-before-starting-windows-service/" data-via="dinhyen" data-counturl="http://dinhyen.github.io/blog/2013/09/27/wix-executing-custom-action-before-starting-windows-service/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/09/26/wix-batch-file/" title="Previous Post: Wix: Batch files.  Yes, really.">&laquo; Wix: Batch files.  Yes, really.</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/09/28/simple-table-sorting-with-angular/" title="Next Post: Simple table sorting with Angular">Simple table sorting with Angular &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul id="categories">
    
     
      <li data-category="Photoshop">
        <a href="/blog/categories/photoshop">Photoshop</a> <em>2</em>
      </li>
    
     
      <li data-category="travel">
        <a href="/blog/categories/travel">travel</a> <em>20</em>
      </li>
    
     
      <li data-category="outdoors">
        <a href="/blog/categories/outdoors">outdoors</a> <em>9</em>
      </li>
    
     
      <li data-category="photography">
        <a href="/blog/categories/photography">photography</a> <em>20</em>
      </li>
    
     
      <li data-category="hockey">
        <a href="/blog/categories/hockey">hockey</a> <em>11</em>
      </li>
    
     
      <li data-category="city">
        <a href="/blog/categories/city">city</a> <em>6</em>
      </li>
    
     
      <li data-category="drawing">
        <a href="/blog/categories/drawing">drawing</a> <em>1</em>
      </li>
    
     
      <li data-category="technology">
        <a href="/blog/categories/technology">technology</a> <em>46</em>
      </li>
    
     
      <li data-category="review">
        <a href="/blog/categories/review">review</a> <em>25</em>
      </li>
    
     
      <li data-category="hiking">
        <a href="/blog/categories/hiking">hiking</a> <em>9</em>
      </li>
    
     
      <li data-category="other">
        <a href="/blog/categories/other">other</a> <em>2</em>
      </li>
    
  </ul>
</section>
<script type="text/javascript">
  $(function() {
    var categories = [];
    $('[data-category]').each(function() {
      categories.push(this);
    });
    categories.sort(function (a, b) {
      return a.attributes['data-category'].value.toLowerCase() <= b.attributes['data-category'].value.toLowerCase()
            ? -1 : 1;
    });
    $('#categories').html(categories);
  });
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/04/08/installing-curt-11064-trailer-hitch-on-a-2009-honda-fit-sport/">Installing the Curt 11064 Trailer Hitch on a 2009 Honda Fit Sport</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/16/how-to-not-upgrade-the-nexus-7-to-lollipop/">How to Not Upgrade the Nexus 7 to Lollipop</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/09/validating-multiple-fields-with-angular/">Validating Multiple Fields With Angular</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/24/validating-required-form-fields-with-angular/">Validating Required Form Fields With Angular</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/angular-in-jekyll-or-octopress/">Angular in Jekyll/Octopress</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Yen Tran -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
