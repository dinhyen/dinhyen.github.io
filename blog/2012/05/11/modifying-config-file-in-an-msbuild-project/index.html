
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Modifying .config file in an MSBuild project - Yen's Blog</title>
  <meta name="author" content="Yen Tran">

  
  <meta name="description" content="We use Hudson to deploy our web application to different environments such as QA, demo and production. We need to customize the web.config, primarily &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dinhyen.github.io/blog/2012/05/11/modifying-config-file-in-an-msbuild-project">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Yen's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/darkbox.css" rel="stylesheet" type="text/css">
<script src="/javascripts/darkbox.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24469490-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Yen's Blog</a></h1>
  
    <h2>Lens, Wheels, Skates, Keyboard</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dinhyen.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/travel">Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Modifying .config File in an MSBuild Project</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-11T00:00:00-04:00" pubdate data-updated="true">May 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>We use <a href="http://hudson-ci.org">Hudson</a> to deploy our web application to different environments such as QA, demo and production. We need to customize the web.config, primarily the database connection string, for each environment . Previously we had to maintain multiple copies of the web.config and copy the appropriate one for each deployment destination.  Obviously keeping around different versions of the same file is far from ideal.</p>

<p>As an improvement, we decide to keep a single web.config and modify the connection string on the fly during deployment.  Fortunately, MSBuild provides the tasks to do just this.  XmlPeek reads from and XmlPoke modifies the content of an XML file using XPath syntax.</p>

<p>The XmlPeek and XmlPoke tasks are available with MSBuild 4.0.  Unfortunately we are constrained to using MSBuild 3.5, so we had to add the following references to the MSBuild project.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;UsingTask</span> <span class="na">TaskName=</span><span class="s">&quot;Microsoft.Build.Tasks.XmlPeek&quot;</span> <span class="na">AssemblyName=</span><span class="s">&quot;Microsoft.Build.Tasks.v4.0, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;UsingTask</span> <span class="na">TaskName=</span><span class="s">&quot;Microsoft.Build.Tasks.XmlPoke&quot;</span> <span class="na">AssemblyName=</span><span class="s">&quot;Microsoft.Build.Tasks.v4.0, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our connection string is stored in the typical manner in the web.config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;connectionStrings&gt;</span>
</span><span class='line'>    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;MyAppConnectionString&quot;</span> <span class="na">connectionString=</span><span class="s">&quot;Data Source=default;Initial Catalog=default;Integrated Security=SSPI;&quot;</span>
</span><span class='line'>      <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/connectionStrings&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We pass in the new value of the connection string as a project parameter named MyConnectionString, which Hudson turns into an environment variable named <code>$(MyConnectionString)</code>.  We make it a project parameter so that it can be modified as needed by IT without help from development.  The connection string has to be URL-encoded; for example, semicolons must be replaced by <code>%3B</code> as shown below.</p>

<p><img src="https://dl.dropboxusercontent.com/u/52804626/images/hudson-conn-string.png" title="hudson-conn-string" width="739" height="128" class="aligncenter size-full wp-image-1148" /></p>

<p>The following snippets read and replace the value of the connection string.  The XPath query returns the connection string attribute for any node which has the name attribute of MyAppConnectionString.  Note that the XML namespace must be HTML-encoded. We don&rsquo;t need the value of the existing connection string, but can use it for logging purpose.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;PropertyGroup&gt;</span>
</span><span class='line'>  <span class="nt">&lt;WebConfig&gt;</span>c:\builds\MyApp\Web.config<span class="nt">&lt;/WebConfig&gt;</span>
</span><span class='line'><span class="nt">&lt;/PropertyGroup&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;ReadWebConfig&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;XmlPeek</span> <span class="na">Namespaces=</span><span class="s">&quot;&amp;lt;Namespace Prefix=&#39;msb&#39; Uri=&#39;http://schemas.microsoft.com/developer/msbuild/2003&#39;/&amp;gt;&quot;</span>
</span><span class='line'>      <span class="na">XmlInputPath=</span><span class="s">&quot;$(WebConfig)&quot;</span>
</span><span class='line'>      <span class="na">Query=</span><span class="s">&quot;//add[@name=&#39;MyAppConnectionString&#39;]/@connectionString&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Result&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;Peeked&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/XmlPeek&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Message</span> <span class="na">Text=</span><span class="s">&quot;@(Peeked)&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Target&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;UpdateWebConfig&quot;</span>  <span class="na">Condition=</span><span class="s">&quot; &#39;$(MyAppConnectionString)&#39; != &#39;&#39; &quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;XmlPoke</span> <span class="na">Namespaces=</span><span class="s">&quot;&amp;lt;Namespace Prefix=&#39;msb&#39; Uri=&#39;http://schemas.microsoft.com/developer/msbuild/2003&#39;/&amp;gt;&quot;</span>
</span><span class='line'>      <span class="na">XmlInputPath=</span><span class="s">&quot;$(WebConfig)&quot;</span>
</span><span class='line'>      <span class="na">Query=</span><span class="s">&quot;//add[@name=&#39;MyAppConnectionString&#39;]/@connectionString&quot;</span>
</span><span class='line'>      <span class="na">Value=</span><span class="s">&quot;$(MyAppConnectionString)&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Target&gt;</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yen Tran</span></span>

      








  


<time datetime="2012-05-11T00:00:00-04:00" pubdate data-updated="true">May 11<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://dinhyen.github.io/blog/2012/05/11/modifying-config-file-in-an-msbuild-project/" data-via="dinhyen" data-counturl="http://dinhyen.github.io/blog/2012/05/11/modifying-config-file-in-an-msbuild-project/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/05/10/backing-up-your-site-with-vdeck/" title="Previous Post: Backing up your site with VDeck">&laquo; Backing up your site with VDeck</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/05/18/deleting-from-collection-with-linq-to-sql/" title="Next Post: Deleting from collection with LINQ to SQL">Deleting from collection with LINQ to SQL &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul id="categories">
    
     
      <li data-category="Photoshop">
        <a href="/blog/categories/photoshop">Photoshop</a> <em>2</em>
      </li>
    
     
      <li data-category="travel">
        <a href="/blog/categories/travel">travel</a> <em>20</em>
      </li>
    
     
      <li data-category="outdoors">
        <a href="/blog/categories/outdoors">outdoors</a> <em>9</em>
      </li>
    
     
      <li data-category="photography">
        <a href="/blog/categories/photography">photography</a> <em>20</em>
      </li>
    
     
      <li data-category="hockey">
        <a href="/blog/categories/hockey">hockey</a> <em>11</em>
      </li>
    
     
      <li data-category="city">
        <a href="/blog/categories/city">city</a> <em>6</em>
      </li>
    
     
      <li data-category="drawing">
        <a href="/blog/categories/drawing">drawing</a> <em>1</em>
      </li>
    
     
      <li data-category="technology">
        <a href="/blog/categories/technology">technology</a> <em>37</em>
      </li>
    
     
      <li data-category="review">
        <a href="/blog/categories/review">review</a> <em>25</em>
      </li>
    
     
      <li data-category="hiking">
        <a href="/blog/categories/hiking">hiking</a> <em>9</em>
      </li>
    
     
      <li data-category="other">
        <a href="/blog/categories/other">other</a> <em>1</em>
      </li>
    
  </ul>
</section>
<script type="text/javascript">
  $(function() {
    var categories = [];
    $('[data-category]').each(function() {
      categories.push(this);
    });
    categories.sort(function (a, b) {
      return a.attributes['data-category'].value.toLowerCase() <= b.attributes['data-category'].value.toLowerCase()
            ? -1 : 1;
    });
    $('#categories').html(categories);
  });
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/02/07/sports-i-would-watch/">Sports I Would Watch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/07/using-angular-root-scope-for-communication-between-controllers/">Using Angular Root Scope for Communication Between Controllers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/23/updating-sql-server-primary-key/">Updating SQL Server Primary Key</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/19/top-10-archive/">Top 10 Archive</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/so-long-wordpress-hello-octopress/">So Long WordPress, Hello Octopress</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Yen Tran -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
