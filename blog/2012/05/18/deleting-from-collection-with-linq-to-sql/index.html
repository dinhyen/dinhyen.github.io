
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deleting from collection with LINQ to SQL - Yen's Blog</title>
  <meta name="author" content="Yen Tran">

  
  <meta name="description" content="I ran into an subtle bug today. Let&rsquo;s say we have a shopping cart page that displays order details and allows the user to remove items from the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dinhyen.github.io/blog/2012/05/18/deleting-from-collection-with-linq-to-sql">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Yen's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/darkbox.css" rel="stylesheet" type="text/css">
<script src="/javascripts/darkbox.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24469490-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Yen's Blog</a></h1>
  
    <h2>Lens, Wheels, Skates, Keyboard</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dinhyen.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/travel">Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deleting From Collection With LINQ to SQL</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-18T00:00:00-04:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I ran into an subtle bug today.  Let&rsquo;s say we have a shopping cart page that displays order details and allows the user to remove items from the order.  We retrieve the items in the order with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">items</span> <span class="p">=</span> <span class="n">DataContext</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">orderId</span><span class="p">).</span><span class="n">Items</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To remove an item from the order, we have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">itemToDelete</span> <span class="p">=</span> <span class="n">DataContext</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">itemId</span><span class="p">);</span>
</span><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">DeleteOnSubmit</span><span class="p">(</span><span class="n">itemToDelete</span><span class="p">);</span>
</span><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">SubmitChanges</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s run-of-the-mill as far as LINQ to SQL goes.  However, we ran into the issue in which an item was still being listed even after it had been deleted.  It turned out that this was caused by how we handled deleting the item. Because we delete the item directly from the database without updating the collection that contains it,  LINQ to SQL presumably doesn&rsquo;t know that the collection has been modified and doesn&rsquo;t re-fetch it from the database, resulting in the collection being out-of-date.</p>

<p>To fix this issue, we can fetch the items directly from the items table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">items</span> <span class="p">=</span> <span class="n">DataContext</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">OrderId</span> <span class="p">==</span> <span class="n">orderId</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively, we can remove the item from the collection prior to deleting it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">itemToDelete</span> <span class="p">=</span> <span class="n">DataContext</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">itemId</span><span class="p">);</span>
</span><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">DataContext</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="n">Single</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">orderId</span><span class="p">).</span><span class="n">Items</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">itemToDelete</span><span class="p">);</span>
</span><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">DeleteOnSubmit</span><span class="p">(</span><span class="n">itemToDelete</span><span class="p">);</span>
</span><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">SubmitChanges</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yen Tran</span></span>

      








  


<time datetime="2012-05-18T00:00:00-04:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://dinhyen.github.io/blog/2012/05/18/deleting-from-collection-with-linq-to-sql/" data-via="dinhyen" data-counturl="http://dinhyen.github.io/blog/2012/05/18/deleting-from-collection-with-linq-to-sql/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/05/11/modifying-config-file-in-an-msbuild-project/" title="Previous Post: Modifying .config file in an MSBuild project">&laquo; Modifying .config file in an MSBuild project</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/05/20/the-reformatory-branch-trail/" title="Next Post: The Reformatory Branch Trail">The Reformatory Branch Trail &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul id="categories">
    
     
      <li data-category="Photoshop">
        <a href="/blog/categories/photoshop">Photoshop</a> <em>2</em>
      </li>
    
     
      <li data-category="travel">
        <a href="/blog/categories/travel">travel</a> <em>20</em>
      </li>
    
     
      <li data-category="outdoors">
        <a href="/blog/categories/outdoors">outdoors</a> <em>9</em>
      </li>
    
     
      <li data-category="photography">
        <a href="/blog/categories/photography">photography</a> <em>20</em>
      </li>
    
     
      <li data-category="hockey">
        <a href="/blog/categories/hockey">hockey</a> <em>11</em>
      </li>
    
     
      <li data-category="city">
        <a href="/blog/categories/city">city</a> <em>6</em>
      </li>
    
     
      <li data-category="drawing">
        <a href="/blog/categories/drawing">drawing</a> <em>1</em>
      </li>
    
     
      <li data-category="technology">
        <a href="/blog/categories/technology">technology</a> <em>41</em>
      </li>
    
     
      <li data-category="review">
        <a href="/blog/categories/review">review</a> <em>25</em>
      </li>
    
     
      <li data-category="hiking">
        <a href="/blog/categories/hiking">hiking</a> <em>9</em>
      </li>
    
     
      <li data-category="other">
        <a href="/blog/categories/other">other</a> <em>2</em>
      </li>
    
  </ul>
</section>
<script type="text/javascript">
  $(function() {
    var categories = [];
    $('[data-category]').each(function() {
      categories.push(this);
    });
    categories.sort(function (a, b) {
      return a.attributes['data-category'].value.toLowerCase() <= b.attributes['data-category'].value.toLowerCase()
            ? -1 : 1;
    });
    $('#categories').html(categories);
  });
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/15/copying-files-in-hudson/">Copying Files in Hudson</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/09/moca-home-network/">A MoCA Home Network</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/03/simple-tasks-with-grunt/">Simple Tasks With Grunt</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/09/quelques-impressions-sur-la-culture-francaise/">Quelques Impressions Sur La Culture Fran√ßaise</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/07/my-git-cheat-sheet/">My Git Cheat Sheet</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Yen Tran -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
