
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Edit collection with LINQ to SQL - Yen's Blog</title>
  <meta name="author" content="Yen Tran">

  
  <meta name="description" content="Let&rsquo;s say for a shopping cart we have an Order entity, a Product entity and an OrderDetails entity which serves as a bridge. The OrderDetails &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dinhyen.github.io/blog/2012/06/29/editing-collection-with-linq-to-sql">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Yen's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Yen's Blog</a></h1>
  
    <h2>Lens, Wheels, Skates, Keyboard</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dinhyen.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/travel">Travel</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Edit Collection With LINQ to SQL</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-29T00:00:00-04:00" pubdate data-updated="true">Jun 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Let&rsquo;s say for a shopping cart we have an Order entity, a Product entity and an OrderDetails entity which serves as a bridge. The OrderDetails entity has OrderId and ProductId fields to associate products with orders. We also have an Order domain object which is passed from the business logic layer to the repository layer.</p>

<p>Since products can be added or removed from an order, we need to manage the order details for each Order.  We can either update OrderDetails directly in the database or via the Order.OrderDetails collection.</p>

<h3>Deleting</h3>

<p>When handling deletions, we can determine products removed from the order (i.e., products which are present in the database object but not in the domain object) as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">toDelete</span> <span class="p">=</span>
</span><span class='line'>  <span class="k">from</span> <span class="n">od</span> <span class="k">in</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderDetails</span>
</span><span class='line'>  <span class="k">where</span> <span class="p">!</span><span class="n">domainOrder</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">ProductId</span> <span class="p">==</span> <span class="n">od</span><span class="p">.</span><span class="n">ProductId</span><span class="p">)</span>
</span><span class='line'>  <span class="k">select</span> <span class="n">od</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deleting the order details directly from the database works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">DeleteAllOnSubmit</span><span class="p">(</span><span class="n">toDelete</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, trying to delete the order details using the Order.OrderDetails collection removes only the relationship between Order and OrderDetails.  This would fail because of the foreign key constraint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">toDelete</span><span class="p">)</span>
</span><span class='line'>     <span class="n">order</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Adding</h3>

<p>When handling additions, we can determine products added to the order (i.e., products which are present in the domain order object but not in the database order object) as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">toAdd</span> <span class="p">=</span>
</span><span class='line'>  <span class="k">from</span> <span class="n">od</span> <span class="k">in</span> <span class="n">domainOrder</span><span class="p">.</span><span class="n">OrderDetails</span>
</span><span class='line'>  <span class="k">where</span> <span class="p">!</span><span class="n">order</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">ProductId</span> <span class="p">==</span> <span class="n">od</span><span class="p">.</span><span class="n">ProductId</span><span class="p">)</span>
</span><span class='line'>  <span class="k">select</span> <span class="k">new</span> <span class="n">OrderDetails</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>          <span class="n">OrderId</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
</span><span class='line'>          <span class="n">ProductId</span> <span class="p">=</span> <span class="n">od</span><span class="p">.</span><span class="n">ProductId</span>
</span><span class='line'>             <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here a different scenario applies.  Adding directly to the database succeeds, but the Order.OrderDetails collection isn&rsquo;t updated to show the added Products.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DataContext</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">InsertAllOnSubmit</span><span class="p">(</span><span class="n">toAdd</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>To ensure the Order.OrderDetails collection is also up-to-date, we&rsquo;d have to add the order details via the collection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">order</span><span class="p">.</span><span class="n">OrderDetails</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="n">toAdd</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yen Tran</span></span>

      








  


<time datetime="2012-06-29T00:00:00-04:00" pubdate data-updated="true">Jun 29<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/technology/'>technology</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://dinhyen.github.io/blog/2012/06/29/editing-collection-with-linq-to-sql/" data-via="" data-counturl="http://dinhyen.github.io/blog/2012/06/29/editing-collection-with-linq-to-sql/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/05/20/the-reformatory-branch-trail/" title="Previous Post: The Reformatory Branch Trail">&laquo; The Reformatory Branch Trail</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/07/05/acadia-national-park-biking-the-carriage-roads/" title="Next Post: Acadia National Park: Biking the carriage roads">Acadia National Park: Biking the carriage roads &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/02/fixing-windows-media-center-no-tuner-available-error-with-hdhomerun-prime/">Fixing Windows Media Center No Tuner Available Error With HDHomeRun Prime</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/31/helper-method-generate-nested-tags-from-block/">Helper Method to Generate Nested Tags From Block</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/23/bruins-took-down-sabres-in-costly-victory/">Bruins Took Down Sabres in Costly Victory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/28/simple-table-sorting-with-angular/">Simple Table Sorting With Angular</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/27/wix-executing-custom-action-before-starting-windows-service/">Wix: Executing Custom Action Before Starting Windows Service</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yen Tran -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
